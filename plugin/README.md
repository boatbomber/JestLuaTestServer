# JestLuaTestServer Plugin

Roblox Studio plugin that executes Jest Lua tests on behalf of the JestLuaTestServer.

## Overview

This plugin runs inside Roblox Studio and acts as the test execution engine for the JestLuaTestServer system. It receives test files via Server-Sent Events (SSE), deserializes them, executes the tests using Jest Lua, and reports results back to the server.

## Architecture

The plugin consists of these main components:

1. **Main.server.lua**: Entry point that handles plugin initialization
2. **TestsManager/**: Core test execution module
   - **init.lua**: Main test execution manager that handles SSE communication, test deserialization, and result reporting
   - **Logger.lua**: Logging utility for debug output

## How It Works

### 1. Initialization
When the plugin starts, it:
- Waits for the server to be healthy by polling `/health`
- Establishes an SSE connection to `/_events` endpoint with session token authentication
- Begins listening for test execution requests

### 2. Test Reception
Tests are received in chunks via SSE:
- `test_start`: Initializes buffer for incoming test data
- `test_chunk`: Receives binary chunks of the `.rbxm` file
- `test_end`: Triggers test deserialization and execution

### 3. Test Execution
When a complete test is received:
- Deserializes the `.rbxm` file using `SerializationService`
- Injects a default `jest.config` if not present
- Runs the tests using Jest Lua with configured options
- Captures test results or errors

### 4. Result Reporting
After test execution:
- Sends results back to server via POST to `/_results` with session token authentication
- Includes test ID and outcome (success/failure with details)

## Configuration

The plugin reads its configuration from `serverConfig.json`, which is automatically generated by the server during plugin installation. Settings include:

- `host`: Server hostname (default: `127.0.0.1`)
- `port`: Server port (default: `8325`)
- `test_timeout`: Maximum test execution time in milliseconds
- `log_level`: The verbosity of logging
- `bearer_token`: Session-specific authentication token (automatically injected)

## Jest Configuration

Default Jest options used by the plugin:

```lua
{
    verbose = false,
    ci = true,
    testTimeout = <from serverConfig>,
    testMatch = {
        "**/*.(spec|test)",
    },
    testPathIgnorePatterns = {
        "Packages",
        "DevPackages",
    }
}
```

## Installation

The plugin is automatically installed by the server when it starts:

1. Server reads plugin source from this directory
2. Generates a unique session token for internal endpoint authentication
3. Injects current server settings and session token into `serverConfig.json`
4. Builds the plugin using Rojo
5. Installs to Roblox Studio's plugin directory

## Building

To build the plugin manually:

```bash
cd plugin
rojo build -o plugin.rbxm
```

## Project Structure

```
plugin/
├── src/
│   ├── Main.server.lua      # Plugin entry point
│   ├── TestsManager/        # Test execution module
│   │   ├── init.lua         # Main test manager
│   │   └── Logger.lua       # Logging utility
│   └── serverConfig.json    # Server configuration (auto-generated)
├── default.project.json     # Rojo project configuration
└── plugin.rbxm              # Built plugin file (generated)
```

## API

### TestsManager Module

#### Methods

##### `TestsManager:start()`
Initializes the plugin and establishes server connection.

##### `TestsManager:runTest(testId: string)`
Executes a test and returns results.

Returns:
- `{ success: true, results: JestResults }` on success
- `{ success: false, error: string }` on failure

##### `TestsManager:deserializeTest(testId: string)`
Deserializes a buffered `.rbxm` file into Roblox instances.

##### `TestsManager:reportTestOutcome(testId: string, outcome: table)`
Sends test results back to the server.

##### `TestsManager:handleSSEMessage(message: string)`
Processes incoming SSE messages from the server.

## Error Handling

The plugin includes comprehensive error handling:

- Network failures are logged but don't crash the plugin
- Test timeouts are enforced and reported
- Deserialization errors are caught and reported
- Jest execution errors are captured and sent to server

## Debugging

Enable verbose logging by modifying the Jest options:

```lua
local runCLIOptions = {
    verbose = true,  -- Change to true for detailed output
    -- ... other options
}
```

Check the Studio output window for plugin logs and error messages.

## Known Issues

1. **Test Isolation**: Tests run in the same environment, so global state changes may affect subsequent tests

## License

This plugin is part of the JestLuaTestServer project and is licensed under the Apache License 2.0.